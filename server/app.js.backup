// server/app.js - Version compl√®te et corrig√©e
const express = require('express');
const cors = require('cors');
const morgan = require('morgan');
const helmet = require('helmet');
const path = require('path');
const fs = require('fs');

console.log('üîß Configuration du serveur Express...');

const app = express();

// ========== MIDDLEWARE ==========
app.use(helmet());
app.use(cors());

// Logging simplifi√©
app.use(morgan(':method :url :status :res[content-length] - :response-time ms'));

// Parser JSON
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ========== IGNORER FAVICON ==========
app.get('/favicon.ico', (req, res) => {
    console.log('üîï Favicon ignor√©');
    res.status(204).end();
});

// ========== FICHIERS STATIQUES ==========
const publicPath = path.join(__dirname, 'public');
console.log('üìÅ Dossier statique:', publicPath);

// Cr√©er le dossier public s'il n'existe pas
if (!fs.existsSync(publicPath)) {
    console.log('üìÇ Cr√©ation du dossier public...');
    fs.mkdirSync(publicPath, { recursive: true });
    fs.mkdirSync(path.join(publicPath, 'css'), { recursive: true });
    fs.mkdirSync(path.join(publicPath, 'js'), { recursive: true });
}

app.use(express.static(publicPath));

// ========== ROUTES API ==========

// Route de sant√©
app.get('/api/health', (req, res) => {
    console.log('‚ù§Ô∏è  Health check');
    res.json({ 
        status: 'OK', 
        message: 'Serveur Cabinet Psychiatrique',
        timestamp: new Date().toISOString(),
        version: '1.0.0'
    });
});

// Patients API
app.get('/api/patients', (req, res) => {
    console.log('üë• R√©cup√©ration patients');
    try {
        const dataPath = path.join(__dirname, '..', '..', 'data', 'patients.json');
        console.log('üìÑ Chemin patients:', dataPath);
        
        if (fs.existsSync(dataPath)) {
            const data = fs.readFileSync(dataPath, 'utf8');
            let patients = [];
            try {
                patients = JSON.parse(data);
                console.log(`‚úÖ ${patients.length} patients charg√©s`);
            } catch (parseError) {
                console.error('‚ùå Erreur parsing JSON:', parseError.message);
                patients = [];
            }
            res.json(patients);
        } else {
            console.log('‚ÑπÔ∏è  Fichier patients.json non trouv√©');
            res.json([]);
        }
    } catch (error) {
        console.error('üî• Erreur serveur patients:', error.message);
        res.status(500).json({ 
            error: 'Erreur interne',
            message: error.message 
        });
    }
});

// Consultations API
app.get('/api/consultations', (req, res) => {
    console.log('üìÖ R√©cup√©ration consultations');
    try {
        const dataPath = path.join(__dirname, '..', '..', 'data', 'consultations.json');
        console.log('üìÑ Chemin consultations:', dataPath);
        
        if (fs.existsSync(dataPath)) {
            const data = fs.readFileSync(dataPath, 'utf8');
            let consultations = [];
            try {
                consultations = JSON.parse(data);
                console.log(`‚úÖ ${consultations.length} consultations charg√©es`);
            } catch (parseError) {
                console.error('‚ùå Erreur parsing JSON:', parseError.message);
                consultations = [];
            }
            res.json(consultations);
        } else {
            console.log('‚ÑπÔ∏è  Fichier consultations.json non trouv√©');
            res.json([]);
        }
    } catch (error) {
        console.error('üî• Erreur serveur consultations:', error.message);
        res.status(500).json({ 
            error: 'Erreur interne',
            message: error.message 
        });
    }
});

// Wilayas API
app.get('/api/wilayas', (req, res) => {
    console.log('üó∫Ô∏è  R√©cup√©ration wilayas');
    try {
        const dataPath = path.join(__dirname, '..', '..', 'data', 'wilayas.json');
        
        if (fs.existsSync(dataPath)) {
            const data = fs.readFileSync(dataPath, 'utf8');
            const wilayas = JSON.parse(data);
            res.json(wilayas);
        } else {
            // Donn√©es par d√©faut pour l'Alg√©rie
            const defaultWilayas = [
                { code: '16', nom: 'Alger' },
                { code: '31', nom: 'Oran' },
                { code: '19', nom: 'S√©tif' },
                { code: '10', nom: 'Bouira' },
                { code: '9', nom: 'Blida' }
            ];
            res.json(defaultWilayas);
        }
    } catch (error) {
        console.error('Erreur wilayas:', error.message);
        res.json([]);
    }
});

// Professions API
app.get('/api/professions', (req, res) => {
    console.log('üíº R√©cup√©ration professions');
    try {
        const dataPath = path.join(__dirname, '..', '..', 'data', 'professions.json');
        
        if (fs.existsSync(dataPath)) {
            const data = fs.readFileSync(dataPath, 'utf8');
            const professions = JSON.parse(data);
            res.json(professions);
        } else {
            // Professions par d√©faut
            const defaultProfessions = [
                'M√©decin',
                'Enseignant',
                'Ing√©nieur',
                '√âtudiant',
                'Fonctionnaire',
                'Commer√ßant',
                'Retrait√©',
                'Sans emploi'
            ];
            res.json(defaultProfessions);
        }
    } catch (error) {
        console.error('Erreur professions:', error.message);
        res.json([]);
    }
});

// ========== ROUTES HTML ==========

// Page d'accueil
app.get('/', (req, res) => {
    console.log('üè† Requ√™te page d\'accueil');
    const indexPath = path.join(publicPath, 'index.html');
    
    if (fs.existsSync(indexPath)) {
        res.sendFile(indexPath);
    } else {
        // Page de secours
        res.send(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Cabinet Psychiatrique</title>
                <style>
                    body { 
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                        margin: 0; 
                        padding: 0; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .container {
                        background: white;
                        padding: 40px;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                        text-align: center;
                        max-width: 600px;
                        width: 90%;
                    }
                    h1 { 
                        color: #667eea; 
                        margin-bottom: 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 15px;
                    }
                    .status {
                        padding: 15px;
                        border-radius: 8px;
                        margin: 20px 0;
                        text-align: left;
                    }
                    .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
                    .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
                    .btn {
                        display: inline-block;
                        background: #667eea;
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        text-decoration: none;
                        margin: 10px 5px;
                        transition: all 0.3s;
                        border: none;
                        cursor: pointer;
                        font-size: 16px;
                    }
                    .btn:hover {
                        background: #5a67d8;
                        transform: translateY(-2px);
                        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                    }
                    .links {
                        margin-top: 30px;
                        display: flex;
                        flex-wrap: wrap;
                        justify-content: center;
                        gap: 10px;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>
                        <span style="font-size: 2.5rem;">üè•</span>
                        <span>Cabinet Psychiatrique</span>
                    </h1>
                    
                    <div class="status success">
                        <h3>‚úÖ Serveur Express fonctionnel</h3>
                        <p>Le serveur est correctement d√©marr√© sur le port 3000.</p>
                        <p>L'interface web est en cours de chargement...</p>
                    </div>
                    
                    <div id="api-tests">
                        <h3>Tests de connexion API :</h3>
                        <button class="btn" onclick="testAPI()">Tester toutes les APIs</button>
                        <div id="results"></div>
                    </div>
                    
                    <div class="links">
                        <a href="/api/health" class="btn" target="_blank">Health Check</a>
                        <a href="/api/patients" class="btn" target="_blank">Patients API</a>
                        <a href="/api/consultations" class="btn" target="_blank">Consultations API</a>
                        <a href="/api/wilayas" class="btn" target="_blank">Wilayas API</a>
                    </div>
                    
                    <p style="margin-top: 30px; color: #666; font-size: 14px;">
                        Si vous voyez cette page, c'est que index.html n'est pas encore cr√©√©.
                        Cr√©ez le fichier dans <code>server/public/index.html</code>
                    </p>
                </div>
                
                <script>
                    async function testAPI() {
                        const results = document.getElementById('results');
                        results.innerHTML = '<div class="status">Test en cours...</div>';
                        
                        const tests = [
                            { name: 'Test g√©n√©ral', url: '/api/health' },
                            { name: 'Patients', url: '/api/patients' },
                            { name: 'Consultations', url: '/api/consultations' },
                            { name: 'Wilayas', url: '/api/wilayas' },
                            { name: 'Professions', url: '/api/professions' }
                        ];
                        
                        let html = '';
                        for (const test of tests) {
                            try {
                                const response = await fetch(test.url);
                                if (response.ok) {
                                    const data = await response.json();
                                    const count = Array.isArray(data) ? data.length + ' √©l√©ments' : 'OK';
                                    html += \`<div class="status success">\${test.name}: ‚úì \${count}</div>\`;
                                } else {
                                    html += \`<div class="status error">\${test.name}: ‚úó HTTP \${response.status}</div>\`;
                                }
                            } catch (error) {
                                html += \`<div class="status error">\${test.name}: ‚úó \${error.message}</div>\`;
                            }
                        }
                        
                        results.innerHTML = html;
                    }
                    
                    // Test automatique au chargement
                    setTimeout(testAPI, 1000);
                </script>
            </body>
            </html>
        `);
    }
});

// Route catch-all pour SPA
app.get('*', (req, res) => {
    console.log(`üîÑ Route non g√©r√©e: ${req.url}`);
    res.status(404).send(`
        <!DOCTYPE html>
        <html>
        <head><title>404 - Page non trouv√©e</title></head>
        <body style="font-family: Arial; padding: 40px; text-align: center;">
            <h1>404 - Page non trouv√©e</h1>
            <p>La page <code>${req.url}</code> n'existe pas sur ce serveur.</p>
            <p><a href="/" style="color: #667eea;">Retour √† l'accueil</a></p>
        </body>
        </html>
    `);
});

// ========== GESTION ERREURS ==========
app.use((err, req, res, next) => {
    console.error('üî• ERREUR SERVEUR:', {
        message: err.message,
        stack: err.stack,
        url: req.url,
        method: req.method
    });
    
    res.status(500).json({
        error: 'Erreur serveur interne',
        message: process.env.NODE_ENV === 'development' ? err.message : 'Contactez l\'administrateur',
        timestamp: new Date().toISOString()
    });
});

console.log('‚úÖ Configuration Express termin√©e');
module.exports = app;